<!doctype html>
  <head>
    <title>We Disagree | The most negative comments on top commented CBC articles in the past few days</title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>
      <span class="title">We Disagree</span>
      <span class="subtitle">Negative comments on top commented </span><span class="subtitle">CBC stories from the past few days</span>
    </h1>
    <div id="articles" class="loading">
    </div>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript">
    var totalArticles = 50;
    var age = 1;
    $.ajax({
      url: 'http://sitelife.cbc.ca/ver1.0/sdk/js/tags/REL-5.3.10.CBC.Hotfix.2?jsonRequest=%7B%22Envelopes%22%3A%5B%7B%22Payload%22%3A%7B%22Activity%22%3A%22Commented%22%2C%22Age%22%3A' + age + '%2C%22Categories%22%3A%5B%7B%22Name%22%3A%22all%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoveryCategory%22%7D%5D%2C%22LimitToContributors%22%3A%5B%22Editor%22%2C%22Staff%22%2C%22Trusted%22%2C%22Standard%22%5D%2C%22MaximumNumberOfDiscoveries%22%3A' + totalArticles + '%2C%22ObjectType%22%3A%22Requests.Discovery.DiscoverContentActionRequest%22%2C%22Sections%22%3A%5B%7B%22Name%22%3A%22world%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22canada%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22politics%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22business%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22health%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22arts%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22technology%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%5D%2C%22Type%22%3A%22Article%22%7D%2C%22PayloadType%22%3A%22Requests.Discovery.DiscoverContentActionRequest%22%7D%5D%2C%22Metadata%22%3Anull%2C%22ObjectType%22%3A%22Requests.RequestBatch%22%7D',
      dataType: 'jsonp',
      jsonp: 'cb',
    })
    .always(function() {
      $('#articles').removeClass('loading');
    })
    .fail(function() {
      $('#articles').html('<div class="error">Uh oh, something went wrong!</div>');
    })
    .done(function(body) {
      body.Envelopes[0].Payload.DiscoveredContent.sort(function(a, b) {
        // return b.Comments.NumberOfComments - a.Comments.NumberOfComments;
        return b.ArticleKey.Key - a.ArticleKey.Key;
      });
      $.each(body.Envelopes[0].Payload.DiscoveredContent, function(i, article) {
        var $element = $([
          '<div class="article">',
            '<h2><a href="' + article.Url + '">' + article.Title + '</a></h2>',
            '<div class="meta"></div>',
            '<div class="comment loading"></div>',
          '</div>',
        ].join(''));
        $('#articles').append($element);
        var $meta = $element.find('.meta');
        var $comment = $element.find('.comment');
        var key = article.ArticleKey.Key;
        var order = 'Ascending';
        $.ajax({
          url: 'http://sitelife.cbc.ca/ver1.0/sdk/js/tags/REL-5.3.10.CBC.Hotfix.2?jsonRequest=%7B%22Envelopes%22%3A%5B%7B%22Payload%22%3A%7B%22CommentedOnKey%22%3A%7B%22Key%22%3A%22' + key + '%22%2C%22ObjectType%22%3A%22Models.External.ExternalResourceKey%22%7D%2C%22FilterType%22%3A%7B%22ObjectType%22%3A%22Models.System.Filtering.ThreadFilter%22%2C%22ThreadPath%22%3A%22%2F%22%7D%2C%22ItemsPerPage%22%3A%221%22%2C%22ObjectType%22%3A%22Requests.Reactions.CommentsPageRequest%22%2C%22OneBasedOnPage%22%3A1%2C%22SortType%22%3A%7B%22ObjectType%22%3A%22Models.System.Sorting.ScoreSort%22%2C%22ScoreId%22%3A%22Thumbs%22%2C%22ScoreSortColumn%22%3A%22DeltaScore%22%2C%22SortOrder%22%3A%22' + order + '%22%7D%7D%2C%22PayloadType%22%3A%22Requests.Reactions.CommentsPageRequest%22%7D%5D%2C%22Metadata%22%3Anull%2C%22ObjectType%22%3A%22Requests.RequestBatch%22%7D',
          dataType: 'jsonp',
          jsonp: 'cb',
        })
        .always(function() {
          $comment.removeClass('loading');
        })
        .fail(function() {
          $comment.html('<div class="error">Uh oh, something went wrong!</div>');
        })
        .done(function(body) {
          var date = new Date(body.Envelopes[0].Payload.Items[0].PostedAtTime.split('|')[1]);
          var months = ['January','February','March','April','May','June','July', 'August', 'September', 'October', 'November', 'December'];
          var meta = [
            '<span class="positive">+' + body.Envelopes[0].Payload.Items[0].ScoreData.PositiveScore + '</span> / ',
            '<span class="negative">-' + body.Envelopes[0].Payload.Items[0].ScoreData.NegativeScore + '</span>',
            '<span class="comments">' + body.Envelopes[0].Payload.Items[0].Parent.Comments.NumberOfComments + ' comments</span>',
            '<span class="posted">' + months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear() + '</span>',
          ].join('');
          $meta.append(meta);
          $comment.append(body.Envelopes[0].Payload.Items[0].Body);
        });
      });
    });
    </script>
  </body>
</html>
