<!doctype html>
  <head>
    <title>We Disagree</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="wrap">
      <h1>We Disagree
        <span class="subtitle">The most negative comments on top commented <br>CBC articles in the past few days.</span>
      </h1>
      <div id="articles" class="loading">
      </div>
    </div>
    <div class="footer">Let's just get along!</div>
    <script src="jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript">
    var totalArticles = 30;
    var age = 4;
    $.ajax({
      url: 'http://sitelife.cbc.ca/ver1.0/sdk/js/tags/REL-5.3.10.CBC.Hotfix.2?jsonRequest=%7B%22Envelopes%22%3A%5B%7B%22Payload%22%3A%7B%22Activity%22%3A%22Commented%22%2C%22Age%22%3A' + age + '%2C%22Categories%22%3A%5B%7B%22Name%22%3A%22all%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoveryCategory%22%7D%5D%2C%22LimitToContributors%22%3A%5B%22Editor%22%2C%22Staff%22%2C%22Trusted%22%2C%22Standard%22%5D%2C%22MaximumNumberOfDiscoveries%22%3A' + totalArticles + '%2C%22ObjectType%22%3A%22Requests.Discovery.DiscoverContentActionRequest%22%2C%22Sections%22%3A%5B%7B%22Name%22%3A%22world%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22canada%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22politics%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22business%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22health%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22arts%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%2C%7B%22Name%22%3A%22technology%22%2C%22ObjectType%22%3A%22Models.Discovery.DiscoverySection%22%7D%5D%2C%22Type%22%3A%22Article%22%7D%2C%22PayloadType%22%3A%22Requests.Discovery.DiscoverContentActionRequest%22%7D%5D%2C%22Metadata%22%3Anull%2C%22ObjectType%22%3A%22Requests.RequestBatch%22%7D',
      dataType: 'jsonp',
      jsonp: 'cb',
    })
    .always(function() {
      $('#articles').removeClass('loading');
    })
    .fail(function() {
      $('#articles').html('<div class="error">Uh oh, something went wrong!</div>');
    })
    .done(function(body) {
      body.Envelopes[0].Payload.DiscoveredContent.sort(function(a, b) {
        return b.Comments.NumberOfComments - a.Comments.NumberOfComments;
      });
      $.each(body.Envelopes[0].Payload.DiscoveredContent, function(i, article) {
        var $element = $([
          '<div class="article">',
            '<div class="title clearfix">',
              '<span class="meta">' + article.Comments.NumberOfComments + ' comments</span>',
              '<h2 class="body"><a href="' + article.Url + '">' + article.Title + '</a></h2>',
            '</div>',
            '<div class="comment clearfix loading"></div>',
          '</div>',
        ].join("\n"));
        $('#articles').append($element);
        var $comment = $element.find('.comment');
        var key = article.ArticleKey.Key;
        var order = 'Ascending';
        $.ajax({
          url: 'http://sitelife.cbc.ca/ver1.0/sdk/js/tags/REL-5.3.10.CBC.Hotfix.2?jsonRequest=%7B%22Envelopes%22%3A%5B%7B%22Payload%22%3A%7B%22CommentedOnKey%22%3A%7B%22Key%22%3A%22' + key + '%22%2C%22ObjectType%22%3A%22Models.External.ExternalResourceKey%22%7D%2C%22FilterType%22%3A%7B%22ObjectType%22%3A%22Models.System.Filtering.ThreadFilter%22%2C%22ThreadPath%22%3A%22%2F%22%7D%2C%22ItemsPerPage%22%3A%221%22%2C%22ObjectType%22%3A%22Requests.Reactions.CommentsPageRequest%22%2C%22OneBasedOnPage%22%3A1%2C%22SortType%22%3A%7B%22ObjectType%22%3A%22Models.System.Sorting.ScoreSort%22%2C%22ScoreId%22%3A%22Thumbs%22%2C%22ScoreSortColumn%22%3A%22DeltaScore%22%2C%22SortOrder%22%3A%22' + order + '%22%7D%7D%2C%22PayloadType%22%3A%22Requests.Reactions.CommentsPageRequest%22%7D%5D%2C%22Metadata%22%3Anull%2C%22ObjectType%22%3A%22Requests.RequestBatch%22%7D',
          dataType: 'jsonp',
          jsonp: 'cb',
        })
        .always(function() {
          $comment.removeClass('loading');
        })
        .fail(function() {
          $comment.html('<div class="error">Uh oh, something went wrong!</div>');
        })
        .done(function(body) {
          var date = new Date(body.Envelopes[0].Payload.Items[0].PostedAtTime.split('|')[1]);
          var months = ['Jan','Feb','March','April','May','June','July', 'August', 'Sept', 'Oct', 'Nov', 'Dec'];
          var comment = [
            '<div class="meta">',
              '<div class="score">',
                '<span class="positive">+' + body.Envelopes[0].Payload.Items[0].ScoreData.PositiveScore + '</span> / <span class="negative">-' + body.Envelopes[0].Payload.Items[0].ScoreData.NegativeScore + '</span>',
              '</div>',
              '<div class="posted">' + months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear() + '</div>',
            '</div>',
            '<div class="body">' + body.Envelopes[0].Payload.Items[0].Body + '</div>',
          ].join("\n");
          $comment.append(comment);
        });
      });
    });
    </script>
  </body>
</html>
